# -*- mode: ruby -*-
# vi: set ft=ruby :

# pxe-pilot sandbox — Vagrantfile
#
# Defines the "pxe-vm" that runs pxe-pilot + dnsmasq via Docker.
# Supports two network modes:
#
#   isolated (default for VirtualBox)
#     NIC1: NAT (internet)
#     NIC2: intnet / private switch (PXE traffic, 10.10.10.0/24)
#     dnsmasq runs full DHCP — zero risk to your real network
#
#   bridged (default for Hyper-V)
#     NIC1: external switch / bridged adapter (your real LAN)
#     dnsmasq runs proxy DHCP — only answers PXE requests, router handles IPs
#
# Environment variables:
#   PXE_MODE           — "isolated" or "bridged" (default: isolated)
#   PXE_BRIDGE         — host NIC for bridging (VirtualBox, prompted if unset)
#   PXE_HYPERV_SWITCH  — Hyper-V virtual switch name
#   PXE_DHCP_START     — first IP in DHCP range  (isolated only, default: 10.10.10.100)
#   PXE_DHCP_END       — last IP in DHCP range   (isolated only, default: 10.10.10.200)

Vagrant.configure("2") do |config|
  config.vm.define "pxe-vm" do |pxe|
    pxe.vm.box = "generic/ubuntu2204"
    pxe.vm.hostname = "pxe-vm"

    mode = ENV["PXE_MODE"] || "isolated"

    if mode == "bridged"
      # Bridged: VM joins the host's real LAN
      bridge = ENV["PXE_BRIDGE"] || ENV["PXE_HYPERV_SWITCH"] || nil
      if bridge
        pxe.vm.network "public_network", bridge: bridge
      else
        # Vagrant will prompt the user to pick an interface
        pxe.vm.network "public_network"
      end
    else
      # Isolated: private network, static IP, no conflict with real LAN
      pxe.vm.network "private_network",
        ip: "10.10.10.11",
        netmask: "255.255.255.0"
    end

    # --- VirtualBox provider ---
    pxe.vm.provider "virtualbox" do |vb|
      vb.name = "pxe-pilot-sandbox"
      vb.memory = 2048
      vb.cpus = 2
      # Promiscuous mode on NIC2 so DHCP/TFTP broadcasts work
      vb.customize ["modifyvm", :id, "--nicpromisc2", "allow-all"]
    end

    # --- Hyper-V provider ---
    pxe.vm.provider "hyperv" do |hv|
      hv.vmname = "pxe-pilot-sandbox"
      hv.memory = 2048
      hv.cpus = 2
      hv.enable_virtualization_extensions = false
    end

    # Sync repo root into the VM so we can docker build from source
    # SMB (Hyper-V default) often fails silently — use rsync instead
    pxe.vm.synced_folder "..", "/vagrant", type: "rsync",
      rsync__exclude: [
        ".vagrant/",
        "*.vhdx",
        "*.vdi",
        ".smoke-test-assets/",
        "node_modules/",
        "__pycache__/",
      ]

    # Provision: install Docker, build image, start services
    pxe.vm.provision "shell",
      path: "provision/setup.sh",
      env: {
        "PXE_MODE"   => mode,
        "DHCP_START" => ENV["PXE_DHCP_START"] || "10.10.10.100",
        "DHCP_END"   => ENV["PXE_DHCP_END"]   || "10.10.10.200",
      }
  end
end
